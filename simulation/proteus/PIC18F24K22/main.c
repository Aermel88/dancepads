/* Main.c file generated by New Project wizard
 *
 * Created:   Sa Nov 2 2013
 * Processor: PIC18F24K22
 * Compiler:  MPLAB XC8
 */

#include <xc.h>
#include <p18cxxx.h>
#include <stdint.h>
#include <spi.h>

#include "dp_adc.h"
#include "dp_led.h" 
#include "dp_spi.h"

#define _XTAL_FREQ 4000000
#define MAX (32)

void set_wren(void);




void main(void)
{
    uint8_t max = MAX;
    uint8_t r=0, g=0, b=0;
    uint8_t s=0, result=0;
    
    int8_t adc=1;
    uint8_t cmd_from_master;
    
    // Debug LED
    TRISCbits.TRISC2 = 0;
    PORTCbits.RC2 = 0;

    // Initialize ADC
    OpenADC ( 
        ADC_FOSC_16 & ADC_RIGHT_JUST & ADC_4_TAD, // ADC_4_TAD = Converting over 4*(1/(FOSC/16)) = 4*(1/250kHz) = 16us
        ADC_CH0 & ADC_INT_OFF & ADC_REF_VDD_VSS, // FOSC = 4 MHz
        0b0000000000000001 // wieso geht ADC_1ANA nicht?
    );

    // Open SPI
    OpenSPI1(SLV_SSON, MODE_00, SMPMID);

    // Initialize
    // .adc with initial Convertion
    // .cmd_from_master
    ConvertADC();
    //PORTCbits.RC2 = 1;
    cmd_from_master = ReadSPI1();
    

    // Write your code here
    while (1) {

        if (!BusyADC()) {
            // ReadADC returns 10bit in 16bit uint16
            // Right-Shift 2Bit and read lowest 8bit
            adc = ReadADC() >> 2;
            ConvertADC();
        }
        
        while(0 != WriteSPI1(183) );
        //WriteSPI1(adc) ;
        DataRdySPI1();
        //Read Command or Color from Master:
        cmd_from_master = ReadSPI1();
        //DataRdySPI1();
        

    }
 }
 
